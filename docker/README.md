# Опис конфігурації Docker-контейнерів 

## Структура проекту

| Папка/файл                | Призначення              |
|:--------------------------|:-------------------------| 
|**``docker-run.sh``**      | основний скрипт для запуску всіх контейнерів |     
|**``.env``**               | основний конфігураційний файл |  
| ``data``                  | папка з даними користувача         | 
|``web_server``             | контейнер для веб-серверу (Apache + PHP)   |     
|``docker-apache.sh``       | підключення до контейнеру з веб-сервером (CLI xdebug) |   
|``docker-proxy.sh``        | підключення до контейнеру з проксі-сервером  |     
|``docker-mysql.sh``        | підключення до контейнеру з MySQL-сервером  |       
|``docker-clean.sh``        | скрипт очищення завантажених Docker-образів |     
|``docker-compose.yml``     | налаштування для docker-compose  |     
|``.dockerignore``          | список файлів які не повинні попадати в контенера Docker  |     
|``.gitattributes``         | налаштування для Git |     
|``.gitignore``             | налаштування файлів для ігнорування додавання в Git |     


## Порядок встановлення
1.  Встановити [Docker](https://docs.docker.com/engine/install/ubuntu/) і обов'язково виконати інструкції з  https://docs.docker.com/engine/install/linux-postinstall/ 
це дасть змогу запускати докер і апач в докері від основного користувача в системі і не буде проблем з правами доступу. 

2. Локальний порт **443 (SSL) має бути вільним**.

3. Початкове налаштування докера полягає в налаштуванні параметрів файлу `.env`

4. Налаштувати скрипти автозаміни даних в базі даних у файлі `data/autostart/010-update.sh`. Можна додати свої скрипти у папку `data/autostart/` (виконуються щоразу при старті докера)

5. Якщо потрібно в імейдж доінсталювати якісь програми, це можна зробити у докер файлі `web_server/Dockerfile` (виконується один раз при побудові контейнера)

6. Для запуску і перезапуску зручно використовувати скрипт `docker-run.sh` даний скрипт робить перезбірку і запуск Docker контейнерів. У випадку будь-яких проблем можна використовувати скрипт  `docker-сlean.sh` він видаляє всі образи, контейнери і розділи.

При запуску система автоматично перевірить чи раніше була розгорнута БД, якщо ні, то спробує отримати останній бекап з папки `data/dumps/*.sql` , 
якщо бекапів в папці не знайдено, відбувається спроба отримати БД з віддаленого сервера MySQL. 
При першому запуску докера це займає декілька хвилин, тому перший  запуск може тривати взалежності від розміру БД і швидкості інтернет з'єднання. БД зберігається локально в `data/mysql` .

### Опис основних параметрів 

>DOMAIN=localhost

**DOMAIN** - домен, по якому буде доступний проект, також вказує на папку в яку буде склонований проект. У випадку клонування ця папка буде задана як _DocumentRoot_.

>SITE_PROXY_DOMAIN=localhost

**SITE_PROXY_DOMAIN** - домен, який використовується для проксювання, якщо не задано, то буде використане значення `DOMAIN`. 

>PLATTFORM=CLEAR

**PLATTFORM** - вказує на тип платформи, вливає на команди перевірки заливки БД та додавання кронів після розгортання контейнеру.
Конфігурація CLEAR не виконує ніяких додаткових перевірок окрім наявності БД. 
Необхідно вказати платформу `OXID, OXID6, SHOPWARE, MAGENTO2, ESPO, KENNERPIM, KENNERCORE, CLEAR`.

>APACHE_PORT=8081

**APACHE_PORT** - порт на якому доступний веб-сервер Apache. Сайт доступний за адресою [http://localhost:8081]()
 
>MAILHOG_PORT=8025

**MAILHOG_PORT** - порт для MailHog  доступний по адресі  [http://localhost:8025](), призначений для перегляду почти. Також всі системні помилки контейнеру будуть надсилатися на почту в  MailHog.

> PHPMYADMIN_PORT=8084

**PHPMYADMIN_PORT** - порт підключення до phpMyAdmin  доступний по адресі  [http://localhost:8084]()

>MYSQL_PORT=1306

**MYSQL_PORT** - порт для підключення до MySQL серверу зовні, наприклад через MySQL Workbench. Параметри підключення host: localhost port: 13306

>PROXY_PORT=8089

**PROXY_PORT=8089** - порт для переходу на сайт з захищеним доменом через проксі [http://localhost:8089]().
При переході по даному адресу, звернення буде автоматично трансльовано в  передід по живому домену, локально в хости нічого прописувати не треба 

>PHP_VER=7.3

**PHP_VER** - версія PHP в контейнері. Для Apache і для CLI. Допустимі значення `5.6, 7.0, 7.1, 7.2, 7.3`

>PHP_XDEBUG=0

**PHP_XDEBUG** - включає xDebug модуль для РНР. Для Apache і для CLI. Допустимі значення `1, 0 або відсутнє значення`

>MYSQL_DATABASE=db

**MYSQL_DATABASE** - ім'я локальної БД в конейнері database_server. 

>MYSQL_USER=db

**MYSQL_USER** - користувач для локальної БД в конейнері database_server. 

>MYSQL_PASSWORD=db

**MYSQL_PASSWORD** - пароль користувач для локальної БД в конейнері database_server. 

>MYSQL_ROOT_PASSWORD=root

**MYSQL_PASSWORD** - пароль користувач root для локальної БД в конейнері database_server, цей пароль можна використовувати для підключення зовні.  

>SSH_REMOTE_USER

**SSH_REMOTE_USER** - SSH користувач сервера віддаленої бази. Залишити пустим, якщо не потрібно використовувати тунель SSH для стягування БД.

>SSH_REMOTE_PASSWORD

**SSH_REMOTE_PASSWORD** - пароль SSH користувача сервера віддаленої бази. Залишити пустим, якщо не потрібно використовувати тунель SSH для стягування БД.

>MYSQL_REMOTE_DATABASE=docker

**MYSQL_REMOTE_DATABASE** - ім'я віддаленої бази даних, необхідно задавати для стягування БД з віддаленого сервера. 

>MYSQL_REMOTE_USER=docker

**MYSQL_REMOTE_USER**  - користувач для БД для підключення до віддаленого серверу MYSQL_REMOTE_HOST. 

>MYSQL_REMOTE_PASSWORD=docker

**MYSQL_REMOTE_PASSWORD** - пароль користувача БД для підключення до віддаленого серверу `MYSQL_REMOTE_HOST`.

>MYSQL_REMOTE_HOST=db.dev50.de

**MYSQL_REMOTE_HOST** - віддалений хост для клонування БД. Порт використовується стандатрний 3306. Залишити пустим, якщо не використовується віддалений дамп БД.

### Структура проекту в Docker

Файли докера повинні бути розміщені в кореневій папці. Тобто папка проекту - /home/project, а папка з докером повинна бути розміщенна в папці /home/project/docker.

```./
└── home
    └── project - папка з проектом
        ├── docker - папка з Docker
        │   ├── data
        │   ├── web_server
        │   ├── .dockerignore
        │   ├── .env
        │   ├── .gitignore
        │   ├── docker-apache.sh
        │   ├── docker-clean.sh
        │   ├── docker-compose.yml
        │   ├── docker-mysql.sh
        │   ├── docker-proxy.sh
        │   ├── docker-run.sh
        │   └── README.md
        └── index.php - файл проекту знаходиться в папці project
```

- `DocumentRoot` без клонування проектів в контейнері має шлях `/var/www/html` 

- в apache додані змінні середовища, для того щоб розуміти, що ми в докері `ENV=DOCKER` та `SHOPWARE_ENV=dev`.

### Підключення до контейнерів запущених в Docker

В системі є наступні допоміжні скрипти `docker-apache(mysql|proxy).sh`

Дані скрипти призначені для підключення до відповідного контейнеру. 

### Робота з HTTPS

Скрипт `docker-run` автоматично створює довірений сертифікат для домену localhost. Доступ до сервера відбувається по адресі https://localhost. Запит відправляється на контейнер з проксі, де відправляється в закодованому виді на контейнер з веб-сервером.

**!!!Переконайтеся що незапущено локально Apache чи Nginx на порті 443!!!**


### Особливості контейнерів запущених в Docker

1. Для того, щоб почта перенаправлялася в  MAILHOG в системі налаштувати smtp сервер **`mail.server:1025`**

2. Налаштування PHP знаходяться в папці ./web_server/phpX.X/config
Після змін варто перезапустити контейнер

3. Додавання кронів кронів для користувача www-data повинно здіснюватися в скриптах в папці `/data/autostart` в форматі  
			`crontab -l -u www-data | {
				cat;
				printf "\n* * * * * КОМАНДА\n";
			} | crontab -u www-data -`
			
4. Хост бази даних для підключення в середині докеру **database_server**.

### xDebug

Для запуску дебагу потрібно зупинити докер, розкоментувати файли налаштування xDebug:
`docker/web_server/php7.3/config/apache2/conf.d/20-xdebug.ini`
`docker/web_server/php7.3/config/cli/conf.d/20-xdebug.ini`

Після цього запустити докер скриптом `docker-run.sh`.

Налаштувати PhpStorm:
            
![Xdebug](./data/images/xdebugconfig_2.png)
            
![Xdebug](./data/images/xdebugconfig.png)

Для дебагу з CLI, підключитись до контейнера вебсервер скриптом `docker-apache.sh`, поставити брейкпоінти в PhpStorm і з консолі контейнера вебсервера запустити потрібну команду.

### Вирішення проблем xDebug
1. Валідаія в PhphStorm проходить, але брекпоїнти в не спрацьовують.  В налаштуваннях xdebug встановлено xdebug.remote_connect_back = 1, це означає, що  xdebug підключається автоматично на той IP з якого був відпралений запит. Якщо валідація в PhphStorm працює, а підключення нема, то потрібно перевірити чи відкритий порт 9000 на хост машині.
Відкрити порт можна за допомогою команди ``ufw allow 9000``.

2. Також треба перевірити налаштування PhphStorm (пункт вище)

